# Use the official Microsoft .NET SDK image to build the application
FROM mcr.microsoft.com/dotnet/framework/sdk:4.8 AS build-env
WORKDIR /app

# Copy csproj and restore any dependencies (include .sln if solution file is used)
COPY *.csproj ./
COPY *.config ./
RUN nuget restore

# Copy the rest of the project files
COPY . ./

# Build and publish the application
RUN msbuild /p:Configuration=Release /p:OutputPath=out

# Generate nuget package
# NOTE: Adjust according to your actual project structure
ARG BUILD_NUMBER
RUN msbuild /t:pack /p:PackageVersion=$BUILD_NUMBER /p:OutputPath=nugets

# Upload artifacts to nexus
ARG NEXUS_API_KEY
RUN nuget push "nugets\*.nupkg" -ApiKey $NEXUS_API_KEY -Source "https://eldan-repo.devopshift.com/nexus/repository/nuget-hosted/"
